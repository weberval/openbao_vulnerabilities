name: Govulncheck to GitHub Issues

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch:

jobs:
  scan-repositories:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout local code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Process Repositories
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ ! -f repositories.json ]; then
            echo "Error: repositories.json not found."
            exit 1
          fi

          REPOS=$(jq -r '.[]' repositories.json)

          for REPO in $REPOS; do
            echo "------------------------------------------------------"
            echo "Scanning External Repository: $REPO"
            echo "------------------------------------------------------"

            DIR_NAME="repo_$(echo $REPO | tr '/' '_')"
            mkdir -p "$DIR_NAME"

            # Clone external repo
            git clone --depth 1 "https://github.com/$REPO.git" "$DIR_NAME" || { echo "Failed to clone $REPO"; continue; }

            pushd "$DIR_NAME" > /dev/null
            govulncheck -json ./... > ../govuln-results.json || true
            popd > /dev/null

            if [ -s govuln-results.json ]; then
              # Extract OSV findings
              VULNS=$(jq -c 'select(.osv != null) | .osv' govuln-results.json || echo "")

              if [ -n "$VULNS" ]; then
                echo "$VULNS" | while read -r vuln; do
                  ID=$(echo "$vuln" | jq -r '.id')
                  SUMMARY=$(echo "$vuln" | jq -r '.summary // "No summary available"')
                  DETAILS=$(echo "$vuln" | jq -r '.details // "No details available"')
                  
                  # Title includes the external repo name for clarity
                  TITLE="Security: $ID in $REPO"
                  
                  # Check for existing open issues in the CURRENT repository using inlined context
                  EXISTS=$(gh issue list --repo "${{ github.repository }}" --search "$ID $REPO" --state open --json title --jq '.[0].title')

                  if [ "$EXISTS" = "null" ] || [ -z "$EXISTS" ]; then
                    BODY=$(cat <<EOF
          ### govulncheck Finding
          - **Target Repository:** [$REPO](https://github.com/$REPO)
          - **Vulnerability ID:** [$ID](https://pkg.go.dev/vuln/$ID)
          
          ### Summary
          $SUMMARY

          ### Details
          $DETAILS

          ---
          *Note: This issue was generated by the central scanner monitoring external dependencies.*
          EOF
          )
                    echo "Creating issue for $ID ($REPO) in ${{ github.repository }}..."
                    gh issue create --repo "${{ github.repository }}" --title "$TITLE" --body "$BODY" --label "security,govulncheck,vulnerability"
                  else
                    echo "Issue for $ID in $REPO already exists in ${{ github.repository }}. Skipping."
                  fi
                done
              else
                echo "No vulnerabilities found for $REPO."
              fi
            fi

            rm -rf "$DIR_NAME"
            rm -f govuln-results.json
          done
